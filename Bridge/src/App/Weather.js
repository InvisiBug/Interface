////////////////////////////////////////////////////////////////////////
//
//  ██╗    ██╗███████╗ █████╗ ████████╗██╗  ██╗███████╗██████╗
//  ██║    ██║██╔════╝██╔══██╗╚══██╔══╝██║  ██║██╔════╝██╔══██╗
//  ██║ █╗ ██║█████╗  ███████║   ██║   ███████║█████╗  ██████╔╝
//  ██║███╗██║██╔══╝  ██╔══██║   ██║   ██╔══██║██╔══╝  ██╔══██╗
//  ╚███╔███╔╝███████╗██║  ██║   ██║   ██║  ██║███████╗██║  ██║
//   ╚══╝╚══╝ ╚══════╝╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝
//
////////////////////////////////////////////////////////////////////////
//
//   #####
//  #     #  ####  #    # ###### #  ####
//  #       #    # ##   # #      # #    #
//  #       #    # # #  # #####  # #
//  #       #    # #  # # #      # #  ###
//  #     # #    # #   ## #      # #    #
//   #####   ####  #    # #      #  ####
//
////////////////////////////////////////////////////////////////////////
// Express
var express = require("express");
var app = (module.exports = express());

// Schedule
var schedule = require("node-schedule");

// Request
const request = require("request");

////////////////////////////////////////////////////////////////////////
//
//  #     #
//  #     #   ##   #####  #   ##   #####  #      ######  ####
//  #     #  #  #  #    # #  #  #  #    # #      #      #
//  #     # #    # #    # # #    # #####  #      #####   ####
//   #   #  ###### #####  # ###### #    # #      #           #
//    # #   #    # #   #  # #    # #    # #      #      #    #
//     #    #    # #    # # #    # #####  ###### ######  ####
//
////////////////////////////////////////////////////////////////////////
var forecastWeatherData;
var currentWeatherData;

////////////////////////////////////////////////////////////////////////
//
//    #    ######  ###
//   # #   #     #  #
//  #   #  #     #  #
// #     # ######   #
// ####### #        #
// #     # #        #
// #     # #       ###
//
////////////////////////////////////////////////////////////////////////
app.get("/api/weather/get/forecast", (req, res) => {
  res.json(forecastWeatherData);
});

app.get("/api/weather/get/current", (req, res) => {
  res.json(currentWeatherData);
});

////////////////////////////////////////////////////////////////////////
//
// #######
// #       #    # #    #  ####  ##### #  ####  #    #  ####
// #       #    # ##   # #    #   #   # #    # ##   # #
// #####   #    # # #  # #        #   # #    # # #  #  ####
// #       #    # #  # # #        #   # #    # #  # #      #
// #       #    # #   ## #    #   #   # #    # #   ## #    #
// #        ####  #    #  ####    #   #  ####  #    #  ####
//
////////////////////////////////////////////////////////////////////////
var getForecast = () => {
  request(
    "https://api.darksky.net/forecast/1a79dafc70696fa86e4f51559476b6d9/52.954399,-1.135709?units=si&exclude=minutely,hourly,flags,currently",
    (error, response, body) => {
      if (!error && response.statusCode == 200) {
        forecastWeatherData = JSON.parse(body);
      }
    }
  );
};

var getCurrent = () => {
  request(
    "https://api.darksky.net/forecast/1a79dafc70696fa86e4f51559476b6d9/52.954399,-1.135709?units=si&exclude=minutely,hourly,flags,alerts",
    (error, response, body) => {
      if (!error && response.statusCode == 200) {
        currentWeatherData = JSON.parse(body);
      }
    }
  );
};

getForecast();
getCurrent();

////////////////////////////////////////////////////////////////////////
//
//   #####
//  #     #  ####  #    # ###### #####  #    # #      ######
//  #       #    # #    # #      #    # #    # #      #
//   #####  #      ###### #####  #    # #    # #      #####
//        # #      #    # #      #    # #    # #      #
//  #     # #    # #    # #      #    # #    # #      #
//   #####   ####  #    # ###### #####   ####  ###### ######
//
////////////////////////////////////////////////////////////////////////
var weatherUpdate = new schedule.RecurrenceRule();
weatherUpdate.minute = 0;

schedule.scheduleJob(weatherUpdate, function () {
  getForecast();
  getCurrent();
});
